### Project description

This project contains code for fitting 2D maps generated by SLAM algorithms to the ground truth map. More generally it can be used to fit any map to another version of it that has been translated and/or rotated. Here we do not account for reflections because we consider a reflected map to be a different floorplan.


### Interface

There are 3 main used to run the code. One is the image of the ground truth file, another is a json file with the corners of the ground truth (you can find example of such a file in data/ground_truth.json, as well as an explanation in the Data section of this README) and the last one is the image of the map to be fitted to the ground truth.

To run the code using the files in data/ folder you can run the following commands in the command line from the repository directory.

```
cd source
fit_map.py from_gt_img_and_corners_file ../data/ground_truth.json ../data/ground_truth.png ../data/cartographer-slam-floorplan-fast-v3.pgm --show
```

It is also possible to run the code if you only have the corners file and the target floorplan image:

```
fit_map.py from_gt_corners ../data/ground_truth.json ../data/cartographer-slam-floorplan-fast-v3.pgm --show
```
The above command will invoke constructing the ground truth from the json file that will then be used for calculations regarding evaluating various transformations for the input floorplan.

If you just have two maps and no corners/polylines file you can use the following command format:

```
fit_map.py from_gt_img ../data/ground_truth.png ../data/cartographer-slam-floorplan-fast-v3.pgm --show
```
This will run corner detection on ground_truth.png and use the detected corners to run the comparison. It is not enough to generate the ground truth json that contains information about which corner is detected to which other corner and that contains a full set of the corners. It would be possible to write code that would create the correct ground_truth.json for the ground truth file such as data/ground_truth.png because that is a perfect, manually generated file. However, current code does not support that. This is left potentially for future work. You can read more about this at link. However, one does not need to get all the corners in the map for the fitting to be possible. As long as we get two corners in one of the maps and their corresponding two corners in the other map (and that these corners are not very close to each other), the fitting fill provide a correct result. 

#### Options

There are several options that the code can be run with.

##### --show

```
# This option displays the fitted map overlaid on the ground truth image at the end
--show 
```

##### --same_scale

```
# This option signals that both maps have the same scale. This reduces search space and time needed to run the code
--same_scale
```

##### --crop_gt

```
# This options crops the ground truth image so there is only a small padding around useful information in the image.
--crop_gt
```

There is an implicit assumption in the code that the ground truth image is cropped. This assumption was made to reduce the search space and decrease running time. It is expressed as an if condition in fit_map.py.
```
# If after fitting the floorplan is too small, then skip evaluation, it is not the right transform.
# This reduces search space.
ratio = resized_floorplan_area/gt_img_area
if ratio <= MIN_AREA_PCTG:
		continue
```

You can use this option to crop your ground truth. It might fail if you are comparing two noisy maps and the first map has some outlier pixels that make the image larger. You would first have to denoise the image and then crop it.

##### --crop_target

```
# This option crops the floorplan so that there is not too much irrelevant space around the informative part of the image.
--crop_target
```

### Data

data/ folder contains the ground truth .json file, the image of the ground truth and several maps I collected by running 2D lidar SLAM in part of my apartment.

#### Ground truth corners file format

Ground truth file is a file that contains a full description of the area that is being fitted. The area is described as a set of polylines, each polyline described by a sequence of points that connect to each other consecutively. If the polyline describes a loop in the map, then the first and the last point of the polyline are the same. Here is an example of the contents of such a file:

```
{"polylines": 
{"1": [[68.119, 32.68600000000001], [70.659, 32.68600000000001], [71.29400000000001, 31.289], [83.486, 31.289], [83.486, 35.35300000000001], [94.662, 35.35300000000001], [94.662, 33.194], [107.108, 33.194], [107.108, 32.94], [108.759, 32.94], [108.759, 51.101], [85.391, 51.101], [85.391, 52.625], [68.119, 52.625], [68.119, 32.68600000000001]], 
"0": [[48.815000000000005, 38.02], [33.82900000000001, 38.02], [33.82900000000001, 39.798], [18.716, 39.798], [18.716, 38.02], [5.0, 38.02], [5.0, 23.796000000000003], [6.7780000000000005, 23.796000000000003], [6.7780000000000005, 5.0], [26.971000000000004, 5.0], [26.971000000000004, 17.954], [29.003, 17.954], [29.003, 16.938000000000002], [47.79900000000001, 16.938000000000002], [47.79900000000001, 17.954], [49.831, 17.954], [49.831, 16.938000000000002], [68.62700000000001, 16.938000000000002], [68.62700000000001, 17.954], [71.167, 17.954], [71.167, 15.922], [107.48900000000002, 15.922], [107.48900000000002, 11.604000000000001], [120.697, 11.604000000000001], [120.697, 15.033000000000001], [139.366, 15.033000000000001], [139.366, 47.164], [140.89000000000001, 47.164], [140.89000000000001, 123.11], [110.41, 123.11], [110.41, 105.83800000000001], [71.29400000000001, 105.83800000000001], [71.29400000000001, 123.11], [55.165000000000006, 123.11], [55.165000000000006, 103.80600000000001], [48.815000000000005, 103.80600000000001], [48.815000000000005, 38.02]]}}
```

### Examples

Here are some successful examples of fitting.

[[figures/figure-good-floorplan.png]]
[[figures/figure-bad-floorplan.png]]

As we can see in both cases, the floorplan was fitted closely (as much as possible) to the ground truth. The second figure is a bit more interesting because the floorplan itself is quite bad, deformed and incomplete. However, the algorithm succeeds in fitting it to the ground truth in a reasonable fashion.
